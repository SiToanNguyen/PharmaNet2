{% extends 'base.html' %}

{% block content %}
  <div class="form-container">
    <h2>Add Sale Transaction</h2>

    <form method="POST" class="global-form">
      {% csrf_token %}

      <fieldset>
        <legend>Sale Details</legend>
        <p>
          {{ form.transaction_number.label_tag }}
          {{ form.transaction_number }}
        </p>
        <p>
          {{ form.customer.label_tag }}
          {{ form.customer }}
        </p>
        <p>
          {{ form.discount.label_tag }}
          {{ form.discount }}
        </p>
        <p>
          {{ form.cash_received.label_tag }}
          {{ form.cash_received }}
        </p>
        <p>
          {{ form.payment_method.label_tag }}
          {{ form.payment_method }}
        </p>
        <p>
          {{ form.remarks.label_tag }}
          {{ form.remarks }}
        </p>
      </fieldset>

      <fieldset>
        <legend>Sold Products</legend>
        {{ formset.management_form }}

        <table id="productsTable" class="global-table">
          <thead>
            <tr>
              <th>Inventory Item</th>
              <th>Quantity</th>
              <th>Sale Price (€)</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for product_form in formset %}
              <tr class="productRow">
                <td><p>{{ product_form.inventory_item }}</p></td>
                <td><p>{{ product_form.quantity }}</p></td>
                <td><span class="price-display">-</span></td>
                <td>
                    <p>
                        <button type="button" class="cancel-btn" onclick="removeRow(this)">Remove</button>
                    </p>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        <!-- Hidden empty form template for cloning -->
        <div id="empty-form" style="display: none;">
          <table>
            <tr class="productRow">
              <td><p>{{ formset.empty_form.inventory_item.as_widget|safe }}</p></td>
              <td><p>{{ formset.empty_form.quantity }}</p></td>
              <td><span class="price-display">-</span></td>
              <td>
                <button type="button" class="cancel-btn" onclick="removeRow(this)">Remove</button>
              </td>
            </tr>
          </table>
        </div>

        <button type="button" id="addRowBtn" class="submit-btn" onclick="addRow()">Add Product</button>
      </fieldset>

      <div class="form-buttons">
        <button type="submit" class="submit-btn">Submit</button>
        <a href="javascript:history.back()" class="cancel-btn">Cancel</a>
      </div>
    </form>

    {% if form.errors or formset.errors %}
      <div class="error-messages">
        <ul>
          {% for field in form %}
            {% for error in field.errors %}
              <li>{{ field.label }}: {{ error }}</li>
            {% endfor %}
          {% endfor %}
          {% for form in formset %}
            {% for field in form %}
              {% for error in field.errors %}
                <li>{{ field.label }}: {{ error }}</li>
              {% endfor %}
            {% endfor %}
          {% endfor %}
        </ul>
      </div>
    {% endif %}
  </div>

  <!-- Select2 and jQuery for dropdown enhancements -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <script>
    function activateSelect2() {
      $('select[name$="inventory_item"]').select2({
        width: '100%',
        placeholder: "Select product",
        templateSelection: function (data) {
          return data.text || data.id;  // fallback to ID if no label
        }
      });
    }

    function addRow() {
      const totalFormsInput = document.querySelector("input[name$='-TOTAL_FORMS']");
      const formIndex = parseInt(totalFormsInput.value);
      const tableBody = document.getElementById("productsTable").querySelector("tbody");
      const emptyFormDiv = document.getElementById("empty-form");

      let templateRow = emptyFormDiv.querySelector(".productRow").cloneNode(true);

      templateRow.querySelectorAll("input, select, textarea").forEach((el) => {
        if (el.name) el.name = el.name.replace(/__prefix__/, formIndex);
        if (el.id) el.id = el.id.replace(/__prefix__/, formIndex);
        el.value = "";
      });

      tableBody.appendChild(templateRow);
      totalFormsInput.value = formIndex + 1;
      activateSelect2();
      fetchPrices();
    }

    function removeRow(button) {
      let row = button.closest("tr");
      row.remove();
      updateTotalForms();
    }

    function updateTotalForms() {
        let totalForms = document.getElementById("id_products-TOTAL_FORMS");
        totalForms.value = document.querySelectorAll(".productRow").length;
    }

    function checkDuplicateInventorySelections() {
      let selected = [];
      let duplicates = false;

      $('select[name$="inventory_item"]').each(function () {
        const val = $(this).val();
        if (val) {
          if (selected.includes(val)) {
            duplicates = true;
          } else {
            selected.push(val);
          }
        }
      });

      if (duplicates) {
        alert("You've selected the same inventory item more than once!");
        return false;
      }
      return true;
    }

    $(document).ready(function () {
      activateSelect2();
      fetchPrices();

      $('form').on('submit', function (e) {
        if (!checkDuplicateInventorySelections()) {
          e.preventDefault();
        }
      });
    });

    function fetchPrices() {
      $('.productRow').each(function () {
        const row = $(this);
        const select = row.find('select[name$="inventory_item"]');
        const priceDisplay = row.find('.price-display');

        select.off('change').on('change', function () {
          const inventoryId = $(this).val();
          if (!inventoryId) {
            priceDisplay.text("-");
            return;
          }

          $.ajax({
            url: `/get_inventory_price/${inventoryId}/`,  // This is the endpoint we'll create
            method: "GET",
            success: function (data) {
              priceDisplay.text(data.price.toFixed(2) + " €");
            },
            error: function () {
              priceDisplay.text("Error");
            }
          });
        });

        // Trigger once in case of pre-filled form
        select.trigger('change');
      });
    }
  </script>

    <style>
        /* Fix Select2 dropdown to match dark theme */
        .select2-container--default .select2-selection--single {
            background-color: #555;
            border: 1px solid #444;
            color: #f0f0f0;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: #f0f0f0;
            line-height: 38px;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 38px;
        }
        
        .select2-dropdown {
            background-color: #444;
            color: #f0f0f0;
        }
        
        .select2-results__option {
            padding: 8px 12px;
            color: #f0f0f0;
        }
        
        .select2-results__option--highlighted {
            background-color: #4CAF50;
            color: white;
        }

        /* Narrow Quantity input field */
        #productsTable input[name$="quantity"] {
            width: 80px;
            text-align: right;
        }

        /* Widen the Inventory Item dropdown */
        #productsTable select[name$="inventory_item"] {
            width: 100%;
            min-width: 250px;
        }

    </style>
    
{% endblock %}
