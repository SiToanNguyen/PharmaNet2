<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pharmacy Management System</title>
  <script>
    const apiUrl = "https://6fhwkm63x8.execute-api.eu-north-1.amazonaws.com/start";

    async function callLambdaWithRetry(retries = 10, delay = 5000) {
      for (let i = 0; i < retries; i++) {
        try {
          const res = await fetch(apiUrl);
          console.log("Fetch response status:", res.status);

          if (res.status === 503) throw new Error(`HTTP 503 Service Unavailable`);
          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);

          const data = await res.json();
          return data;
        } catch (e) {
          console.warn(`Attempt ${i + 1} failed: ${e.message}`);
          await new Promise(r => setTimeout(r, delay));
        }
      }
      throw new Error(`Failed to start server after ${retries} attempts.`);
    }

    async function startServer() {
      const statusEl = document.getElementById("status");
      const infoEl = document.getElementById("info");
      const urlEl = document.getElementById("server-url");
      const shutdownEl = document.getElementById("shutdown-info");

      statusEl.textContent = "Starting server (this may take a while)...";
      infoEl.textContent = "";
      urlEl.textContent = "";

      try {
        const data = await callLambdaWithRetry();

        if (!data) throw new Error("Response JSON is empty or invalid");

        if (data.status) {
          infoEl.textContent = `Status: ${data.status}`;
        }
        if (data.public_ip) {
          infoEl.textContent += ` | Public IP: ${data.public_ip}`;
        }

        if (data.url) {
          // IMMEDIATELY show the URL
          urlEl.innerHTML = `<a href="${data.url}" target="_blank" rel="noopener">${data.url}</a>`;
          
          // Optionally continue readiness check in background
          statusEl.textContent = "Waiting for server to become ready...";
          checkServerReadiness(data.url);
        } else {
          throw new Error("Invalid response format: 'url' missing");
        }
        if (data.shutdown_at) {
          shutdownEl.textContent = `Server will automatically shut down on ${data.shutdown_at}`;
        }
      } catch (e) {
        statusEl.textContent = `Error starting server: ${e.message}`;
        console.error("Error in startServer:", e);
      }
    }

    async function checkServerReadiness(url) {
      const statusEl = document.getElementById("status");
      const urlEl = document.getElementById("server-url");

      for (let i = 0; i < 30; i++) {
        try {
          const response = await fetch(url);
          if (response.ok) {
            statusEl.textContent = "Server is ready!";
            urlEl.innerHTML = <a href="${url}" target="_blank" rel="noopener">${url}</a>;
            return;
          }
        } catch (e) {
          console.log("Server not ready yet...");
        }
        await new Promise(resolve => setTimeout(resolve, 5000));
      }

      statusEl.textContent = "Server failed to become ready. Try again later.";
      urlEl.innerHTML = `You can try manually at: <a href="${url}" target="_blank" rel="noopener">${url}</a>`;
    }

    window.onload = startServer;
  </script>
</head>
<body>
  <h1>Pharmacy Management System</h1>
  <p id="status">Initializing...</p>
  <p id="info" style="font-style: italic; color: #444;"></p>
  <p id="shutdown-info" style="margin-top: 1em; color: #555;"></p>
  <p id="server-url" style="margin-top: 1em; font-weight: bold;"></p>
</body>
</html>